<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Citizen Complaint Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      color: #0f172a;
    }

    /* Header Styles */
    .navbar {
      background: #ffffff;
      border-bottom: 1px solid #e2e8f0;
      padding: 0.75rem 1rem;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .navbar-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .navbar-left {
      display: flex;
      align-items: center;
      gap: 2rem;
    }

    .navbar-logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.2rem;
      font-weight: 700;
      color: #1F3A8A;
      text-decoration: none;
    }

    .navbar-logo-icon {
      width: 2.5rem;
      height: 2.5rem;
      background: linear-gradient(135deg, #1F3A8A, #0EA5A4);
      border-radius: 0.6rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-weight: 700;
    }

    .navbar-menu {
      display: flex;
      gap: 1.5rem;
      list-style: none;
    }

    .navbar-item {
      text-decoration: none;
      color: #475569;
      font-size: 0.95rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      transition: color 0.2s ease;
    }

    .navbar-item:hover {
      color: #0EA5A4;
    }

    .navbar-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .navbar-user {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: #f1f5f9;
      padding: 0.5rem 1rem;
      border-radius: 0.75rem;
      font-size: 0.9rem;
      color: #1F3A8A;
      font-weight: 500;
    }

    .navbar-logout {
      background: none;
      border: none;
      color: #ef4444;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      transition: color 0.2s ease;
    }

    .navbar-logout:hover {
      color: #dc2626;
    }

    @media (max-width: 768px) {
      .navbar-menu {
        gap: 1rem;
      }

      .navbar-item {
        font-size: 0.85rem;
      }
    }

    .page {
      min-height: 100vh;
      padding: 3rem 1rem;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .text-center {
      text-align: center;
    }

    .title {
      font-size: 2.2rem;
      font-weight: 700;
      color: #1F3A8A;
      margin-bottom: 0.75rem;
    }

    .subtitle {
      font-size: 0.95rem;
      color: #64748b;
    }

    .card {
      margin-top: 2rem;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(12px);
      border-radius: 1.5rem;
      border: 1px solid #e2e8f0;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.2);
      overflow: hidden;
    }

    .card-inner {
      padding: 2rem 2.5rem;
    }

    @media (max-width: 640px) {
      .card-inner {
        padding: 1.5rem 1.25rem;
      }
    }

    label {
      font-size: 0.9rem;
      font-weight: 600;
      color: #1F3A8A;
      display: block;
      margin-bottom: 0.5rem;
    }

    textarea,
    input[type="text"],
    select {
      width: 100%;
      border-radius: 0.9rem;
      border: 2px solid #e2e8f0;
      background: #ffffff;
      padding: 0.7rem 1rem;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    textarea:focus,
    input[type="text"]:focus,
    select:focus {
      border-color: #0EA5A4;
      box-shadow: 0 0 0 2px rgba(14, 165, 164, 0.2);
    }

    select {
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%231F3A8A' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 1.2em;
      cursor: pointer;
    }

    textarea {
      min-height: 12rem;
      resize: none;
    }

    .mb-6 {
      margin-bottom: 1.5rem;
    }

    .mb-8 {
      margin-bottom: 2rem;
    }

    .flex {
      display: flex;
    }

    .items-center {
      align-items: center;
    }

    .gap-2 {
      gap: 0.5rem;
    }

    .gap-3 {
      gap: 0.75rem;
    }

    .gap-4 {
      gap: 1rem;
    }

    .flex-wrap {
      flex-wrap: wrap;
    }

    .justify-between {
      justify-content: space-between;
    }

    .w-full {
      width: 100%;
    }

    .btn-language {
      padding: 0.45rem 1rem;
      border-radius: 0.7rem;
      border: 1px solid #cbd5f5;
      background: #ffffff;
      color: #475569;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
    }

    .btn-language.active {
      background: #1F3A8A;
      color: #ffffff;
      border-color: #1F3A8A;
    }

    .btn-language:hover:not(.active) {
      border-color: #0EA5A4;
      background: rgba(14, 165, 164, 0.05);
    }

    .btn-voice {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      padding: 0.9rem 1.5rem;
      border-radius: 0.9rem;
      border: 2px solid #e2e8f0;
      background: #ffffff;
      color: #475569;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease, transform 0.1s ease;
    }

    .btn-voice.recording {
      background: #fef2f2;
      border-color: #fecaca;
      color: #b91c1c;
      animation: pulse 1.2s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.01);
      }

      100% {
        transform: scale(1);
      }
    }

    .btn-submit {
      width: 100%;
      padding: 1rem 2rem;
      border-radius: 0.9rem;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      color: #ffffff;
      background: linear-gradient(to right, #1F3A8A, #0EA5A4);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.25);
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }

    .btn-submit:hover {
      transform: scale(1.02);
      box-shadow: 0 16px 34px rgba(15, 23, 42, 0.3);
    }

    .btn-submit:active {
      transform: scale(0.98);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.25);
    }

    .btn-locate {
      padding: 0.7rem 1.5rem;
      border-radius: 0.9rem;
      border: 2px solid #e2e8f0;
      background: #ffffff;
      color: #475569;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      transition: background 0.15s ease, border-color 0.15s ease;
    }

    .btn-locate:hover:not(:disabled) {
      border-color: #0EA5A4;
      background: rgba(14, 165, 164, 0.05);
    }

    .btn-locate:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .input-row {
      display: flex;
      gap: 0.75rem;
    }

    @media (max-width: 640px) {
      .input-row {
        flex-direction: column;
      }
    }

    .upload-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      width: 100%;
      padding: 0.9rem 1.5rem;
      border-radius: 0.9rem;
      border: 2px dashed #cbd5f5;
      background: #ffffff;
      color: #475569;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease;
    }

    .upload-label:hover {
      background: rgba(14, 165, 164, 0.05);
      border-color: #0EA5A4;
    }

    .error-text {
      margin-top: 0.4rem;
      font-size: 0.8rem;
      color: #b91c1c;
    }

    .ai-indicator {
      margin-top: 0.75rem;
      background: linear-gradient(to right, #eff6ff, #ecfeff);
      border-radius: 0.9rem;
      border: 1px solid #bfdbfe;
      padding: 0.8rem 1rem;
      font-size: 0.85rem;
      color: #1F3A8A;
    }

    .ai-indicator-sub {
      margin-top: 0.25rem;
      font-size: 0.8rem;
      color: #64748b;
    }

    .loader {
      border-radius: 999px;
      border: 2px solid #e5e7eb;
      border-top-color: #0EA5A4;
      width: 14px;
      height: 14px;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Submitted state */
    .submitted-wrap {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem 1rem;
    }

    .submitted-card {
      max-width: 560px;
      width: 100%;
      background: rgba(255, 255, 255, 0.85);
      border-radius: 1.7rem;
      border: 1px solid #e2e8f0;
      padding: 2.5rem 2.5rem;
      text-align: center;
      box-shadow: 0 22px 44px rgba(15, 23, 42, 0.3);
    }

    .submitted-icon {
      width: 5rem;
      height: 5rem;
      border-radius: 999px;
      margin: 0 auto 1.5rem;
      background: linear-gradient(to bottom right, #22c55e, #059669);
    }

    .submitted-title {
      font-size: 1.9rem;
      font-weight: 700;
      color: #1F3A8A;
      margin-bottom: 0.8rem;
    }

    .submitted-text {
      font-size: 0.95rem;
      color: #64748b;
      margin-bottom: 1.25rem;
    }

    .complaint-id {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-weight: 700;
      color: #0EA5A4;
    }

    .submitted-ai-box {
      margin-bottom: 1.75rem;
      border-radius: 0.9rem;
      border: 1px solid #bbf7d0;
      background: #ecfdf5;
      padding: 0.9rem 1rem;
      font-size: 0.85rem;
      color: #14532d;
    }

    .submitted-ai-label {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .submitted-ai-text {
      font-size: 0.9rem;
      color: #475569;
    }

    /* Priority Badge Styles */
    .priority-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 700;
      font-size: 0.9rem;
    }

    .priority-high {
      background: #fee2e2;
      color: #dc2626;
      border: 2px solid #dc2626;
    }

    .priority-medium {
      background: #fef3c7;
      color: #d97706;
      border: 2px solid #d97706;
    }

    .priority-low {
      background: #dcfce7;
      color: #16a34a;
      border: 2px solid #16a34a;
    }

    /* Tags Styles */
    .tags-label {
      font-size: 0.85rem;
      color: #64748b;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .tags-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .tag-item {
      padding: 0.25rem 0.75rem;
      background: #e0f2fe;
      color: #0369a1;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .btn-again {
      padding: 0.8rem 2.3rem;
      border-radius: 0.9rem;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      color: #ffffff;
      background: linear-gradient(to right, #1F3A8A, #0EA5A4);
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.25);
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }

    .btn-again:hover {
      transform: scale(1.02);
      box-shadow: 0 16px 34px rgba(15, 23, 42, 0.3);
    }

    .btn-again:active {
      transform: scale(0.98);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.25);
    }
  </style>
</head>

<!-- CITIZEN Header -->
<nav class="navbar navbar-citizen" id="header-citizen">
  <div class="navbar-container">
    <div class="navbar-left">
      <a href="landingpage.html" class="navbar-logo">
        <div class="navbar-logo-icon">S</div>
        <span>SAMBANDH.AI</span>
      </a>
      <ul class="navbar-menu">
        <li><a href="landingpage.html" class="navbar-item">üè† Home</a></li>
        <li><a href="complaintportal.html" class="navbar-item">üìù Register</a></li>
        <li><a href="statustracker.html" class="navbar-item">üîç Track</a></li>
      </ul>
    </div>
    <div class="navbar-right">
      <div class="navbar-user">
        <span class="username-display">User</span>
      </div>
      <button class="navbar-logout" onclick="handleLogout()">‚Ü©Ô∏è Logout</button>
    </div>
  </div>
</nav>





<script>
  // Initialize user and header
  function initializeUserDisplay() {
    const userEmail = localStorage.getItem('userEmail');

    if (userEmail) {
      const username = userEmail.split('@')[0];
      const displayNames = document.querySelectorAll('.username-display');
      displayNames.forEach(span => {
        span.textContent = username.charAt(0).toUpperCase() + username.slice(1);
      });
    } else {
      // Redirect if not logged in
      window.location.href = 'login.html';
    }
  }

  // Handle logout
  function handleLogout() {
    localStorage.removeItem('userEmail');
    localStorage.removeItem('userRole');
    window.location.href = 'landingpage.html';
  }

  // Initialize on page load
  initializeUserDisplay();
</script>

<body>
  <!-- Submitted view -->
  <div id="submitted-view" class="submitted-wrap" style="display:none;">
    <div class="submitted-card">
      <div class="submitted-icon"></div>
      <h2 class="submitted-title">Complaint Submitted Successfully!</h2>
      <p class="submitted-text">
        Your complaint has been registered with ID:
        <span id="complaint-id" class="complaint-id"></span>
      </p>
      <div class="submitted-ai-box">
        <div class="submitted-ai-label" id="ai-confidence-label">AI Confidence: 0%</div>
        <div id="ai-classification-details" style="margin-top:1rem;">
          <!-- Priority Badge -->
          <div id="priority-badge" style="display:none;margin-bottom:0.75rem;"></div>
          <!-- Department -->
          <div id="department-info" style="display:none;margin-bottom:0.5rem;font-size:0.9rem;"></div>
          <!-- Tags -->
          <div id="tags-container" style="display:none;margin-bottom:0.5rem;"></div>
          <!-- Reasoning -->
          <div id="ai-reasoning" style="display:none;font-size:0.85rem;color:#64748b;font-style:italic;"></div>
        </div>
        <div class="submitted-ai-text">
          Complaint understood successfully and routed to appropriate department.
        </div>
      </div>
      <button id="btn-again" class="btn-again">Submit Another Complaint</button>
    </div>
  </div>

  <!-- Form view -->
  <div id="form-view" class="page">
    <div class="container">
      <div class="text-center mb-8">
        <h1 class="title">Citizen Complaint Portal</h1>
        <p class="subtitle">
          Submit your grievance and our AI will process it instantly
        </p>
      </div>

      <div class="card">
        <div class="card-inner">
          <!-- Language selector -->
          <div class="mb-6">
            <label>
              <span style="margin-right:0.25rem;">üåê</span>
              Select Language
            </label>
            <div id="language-list" class="flex flex-wrap gap-2"></div>
          </div>

          <!-- Department Filter -->
          <div class="mb-6">
            <label>Department Filter</label>
            <select id="department-filter" required>
              <option value="" disabled selected>Select Department</option>
              <option value="Public Works">Public Works</option>
              <option value="Electricity">Electricity</option>
              <option value="Water Supply">Water Supply</option>
              <option value="Health Services">Health Services</option>
              <option value="Sanitation">Sanitation</option>
              <option value="Education">Education</option>
              <option value="Police">Police</option>
              <option value="Transport">Transport</option>
              <option value="Municipal Corporation">Municipal Corporation</option>
              <option value="Disaster Management">Disaster Management</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <!-- Complaint textarea -->
          <div class="mb-6">
            <label>Describe Your Complaint</label>
            <textarea id="complaint-input"
              placeholder="Explain your issue in detail... Our AI will understand and categorize it automatically."
              required></textarea>
          </div>

          <!-- Voice record -->
          <div class="mb-6">
            <button id="btn-voice" type="button" class="btn-voice">
              <span id="voice-icon">üé§</span>
              <span id="voice-text">Record Voice Complaint (Works in Chrome/Edge)</span>
            </button>
            <p id="voice-error" class="error-text" style="display:none;"></p>
          </div>

          <!-- Upload -->
          <div class="mb-6">
            <label for="file-input" class="upload-label">
              <span>üìé</span>
              <span>Upload Supporting Images</span>
              <input id="file-input" type="file" accept="image/*" multiple style="display:none;" />
            </label>
          </div>

          <!-- Location -->
          <div class="mb-8">
            <label>
              <span style="margin-right:0.25rem;">üìç</span>
              Location Details
            </label>

            <!-- State Dropdown -->
            <div class="mb-4">
              <select id="state-select" required>
                <option value="" disabled selected>Select State</option>
              </select>
            </div>

            <!-- City/District Dropdown -->
            <div class="mb-4">
              <select id="city-select" required disabled>
                <option value="" disabled selected>Select City/District</option>
              </select>
            </div>

            <!-- Detailed Address -->
            <div class="input-row">
              <input id="location-input" type="text" placeholder="Street address, landmark, area..." required />
              <button id="btn-locate" type="button" class="btn-locate">
                <span id="loc-loader" class="loader" style="display:none;"></span>
                <span id="loc-text">Auto-detect</span>
              </button>
            </div>
          </div>

          <!-- Submit -->
          <div class="mb-6">
            <button id="btn-submit" class="btn-submit">Submit Complaint</button>
          </div>

          <!-- AI Indicator -->
          <div id="ai-indicator" style="display:none;">
            <div class="ai-indicator">
              <strong>AI is analyzing your complaint...</strong>
              <div class="ai-indicator-sub">
                Category detected: Infrastructure ‚Ä¢ Priority: Medium
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---- State ----
    const languages = [
      { code: 'en-IN', name: 'English' },
      { code: 'hi-IN', name: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä' },
      { code: 'bn-IN', name: '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ' },
      { code: 'ta-IN', name: '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç' },
      { code: 'te-IN', name: '‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å' }
    ];

    let selectedLanguage = 'en-IN';
    let isRecording = false;
    let isDetectingLocation = false;
    let aiConfidence = 0;
    let recognition = null;
    let aiClassification = null; // Store AI classification results

    // ============================================
    // GEMINI AI CONFIGURATION
    // ============================================
    // TODO: Replace with your actual Gemini API key from https://makersuite.google.com/app/apikey
    const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY_HERE';
    const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';

    /**
     * Classify complaint using Google Gemini AI
     * Detects department, priority, and generates tags
     * Supports multilingual input (Hindi, English, etc.)
     */
    async function classifyComplaint(complaintText) {
      if (!complaintText || complaintText.trim().length < 10) {
        throw new Error('Complaint text too short for classification');
      }

      if (GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY_HERE') {
        console.warn('Gemini API key not configured. Using local rule-based classification.');
        return analyzeComplaint(complaintText);
      }

      const prompt = `You are an AI assistant for a government citizen grievance portal in India. Analyze the following complaint and classify it.

COMPLAINT TEXT:
"${complaintText}"

INSTRUCTIONS:
1. Determine the most appropriate department from this list ONLY:
   - Public Works (roads, bridges, infrastructure)
   - Electricity (power supply, outages, billing)
   - Water Supply (water availability, quality, connections)
   - Health Services (hospitals, clinics, sanitation)
   - Sanitation (garbage, sewage, cleanliness)
   - Education (schools, colleges, facilities)
   - Police (law & order, safety, crime)
   - Transport (buses, traffic, parking)
   - Municipal Corporation (general civic issues)
   - Disaster Management (emergencies, natural disasters)
   - Other (if none of above fit)

2. Assign priority level:
   - High: Safety hazards, emergencies, health risks, urgent infrastructure failures
   - Medium: Service disruptions, infrastructure problems, quality issues
   - Low: Suggestions, minor inconveniences, general feedback

3. Generate 3-5 relevant tags (keywords) in English

4. Provide brief reasoning for your classification

Respond ONLY with valid JSON in this exact format:
{
  "department": "exact department name from list",
  "priority": "High" or "Medium" or "Low",
  "tags": ["tag1", "tag2", "tag3"],
  "reasoning": "brief explanation in 1-2 sentences"
}`;

      try {
        const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contents: [{
              parts: [{ text: prompt }]
            }],
            generationConfig: {
              temperature: 0.2,
              topK: 40,
              topP: 0.95,
              maxOutputTokens: 1024,
            }
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
        }

        const data = await response.json();

        if (!data.candidates || !data.candidates[0]?.content?.parts?.[0]?.text) {
          throw new Error('Invalid API response format');
        }

        const resultText = data.candidates[0].content.parts[0].text;

        // Extract JSON from response (handle markdown code blocks)
        let jsonText = resultText.trim();
        if (jsonText.startsWith('```json')) {
          jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '');
        } else if (jsonText.startsWith('```')) {
          jsonText = jsonText.replace(/```\n?/g, '');
        }

        const classification = JSON.parse(jsonText);

        // Validate required fields
        if (!classification.department || !classification.priority || !classification.tags) {
          throw new Error('Incomplete classification data');
        }

        // Add confidence score (simulated based on response quality)
        classification.confidence = 95;

        return classification;

      } catch (error) {
        console.error('Gemini API Error:', error);

        // Fallback classification
        return {
          department: 'Other',
          priority: 'Medium',
          tags: ['needs-review'],
          reasoning: `Classification failed: ${error.message}. Please select department manually.`,
          confidence: 0,
          error: true
        };
      }
    }

    /**
     * Local rule-based complaint analysis (Fallback/Alternative to Gemini AI)
     * Uses keyword matching and priority rules for instant classification
     */
    function analyzeComplaint(text) {
      text = text.toLowerCase();

      let category = "General";
      let priority = "Low";
      let department = "Other";
      let urgency = "Normal";
      let impact = "Individual";
      let sentiment = "Neutral";

      // --- CRITICAL CONDITIONS ---
      if (containsAny(text, ["fire", "accident", "explosion", "collapse", "flood", "earthquake", "gas leak", "murder", "riot"])) {
        priority = "Critical";
        urgency = "Extreme";
        impact = "Public Safety";
      }

      // --- HIGH PRIORITY CONDITIONS ---
      else if (containsAny(text, ["hospital", "ambulance", "injury", "emergency", "electric shock", "short circuit"])) {
        priority = "High";
        urgency = "High";
        impact = "Life Risk";
      }

      // --- INFRASTRUCTURE ---
      if (containsAny(text, ["road", "bridge", "pothole", "construction", "streetlight", "drain"])) {
        category = "Infrastructure";
        department = "Public Works";
        priority = maxPriority(priority, "High");
      }

      // --- WATER ---
      if (containsAny(text, ["water", "pipeline", "leakage", "sewage", "drinking"])) {
        category = "Water Supply";
        department = "Water Supply";
        priority = maxPriority(priority, "Medium");
      }

      // --- ELECTRICITY ---
      if (containsAny(text, ["electricity", "power cut", "transformer", "voltage", "meter", "light"])) {
        category = "Electricity";
        department = "Electricity";
        priority = maxPriority(priority, "Medium");
      }

      // --- SANITATION ---
      if (containsAny(text, ["garbage", "waste", "cleaning", "mosquito", "dirty", "toilet"])) {
        category = "Sanitation";
        department = "Sanitation";
      }

      // --- HEALTH ---
      if (containsAny(text, ["hospital", "doctor", "medicine", "clinic", "health"])) {
        category = "Healthcare";
        department = "Health Services";
        priority = maxPriority(priority, "High");
      }

      // --- EDUCATION ---
      if (containsAny(text, ["school", "college", "teacher", "exam", "education"])) {
        category = "Education";
        department = "Education";
      }

      // --- POLICE & SAFETY ---
      if (containsAny(text, ["theft", "robbery", "crime", "harassment", "threat", "violence"])) {
        category = "Public Safety";
        department = "Police";
        priority = "Critical";
      }

      // --- TRANSPORT ---
      if (containsAny(text, ["bus", "traffic", "parking", "vehicle", "transport"])) {
        category = "Transport";
        department = "Transport";
      }

      // --- SENTIMENT ANALYSIS ---
      if (containsAny(text, ["angry", "frustrated", "worst", "disgusted", "hopeless"])) {
        sentiment = "Negative";
      }

      // Convert Critical to High for consistency with Gemini
      const finalPriority = priority === "Critical" ? "High" : priority;

      // Convert to format matching Gemini response
      return {
        department: department,
        priority: finalPriority,
        tags: [category.toLowerCase(), urgency.toLowerCase(), impact.toLowerCase()].filter(t => t !== 'general'),
        reasoning: `${category} issue classified as ${priority} priority based on keyword analysis`,
        confidence: 85,
        urgency: urgency,
        impact: impact,
        sentiment: sentiment
      };
    }

    function containsAny(text, words) {
      return words.some(word => text.includes(word));
    }

    function maxPriority(p1, p2) {
      const rank = { "Low": 1, "Medium": 2, "High": 3, "Critical": 4 };
      return rank[p1] > rank[p2] ? p1 : p2;
    }

    // ============================================
    // LOCAL DATABASE (localStorage)
    // ============================================

    /**
     * Save complaint to localStorage database
     */
    function saveComplaint(complaintData) {
      try {
        // Get existing complaints
        const complaints = loadComplaints();

        // Add new complaint
        complaints[complaintData.id] = complaintData;

        // Save back to localStorage
        localStorage.setItem('complaints_db', JSON.stringify(complaints));

        console.log('Complaint saved successfully:', complaintData.id);
        return true;
      } catch (error) {
        console.error('Error saving complaint:', error);
        return false;
      }
    }

    /**
     * Load all complaints from localStorage
     */
    function loadComplaints() {
      try {
        const data = localStorage.getItem('complaints_db');
        return data ? JSON.parse(data) : {};
      } catch (error) {
        console.error('Error loading complaints:', error);
        return {};
      }
    }

    /**
     * Get complaint by ID
     */
    function getComplaintById(id) {
      const complaints = loadComplaints();
      return complaints[id] || null;
    }

    /**
     * Update complaint status
     */
    function updateComplaintStatus(id, status, officerEmail = null) {
      try {
        const complaints = loadComplaints();
        if (complaints[id]) {
          complaints[id].status = status;
          complaints[id].updatedAt = new Date().toISOString();
          if (officerEmail) {
            complaints[id].assignedTo = officerEmail;
          }
          localStorage.setItem('complaints_db', JSON.stringify(complaints));
          return true;
        }
        return false;
      } catch (error) {
        console.error('Error updating complaint:', error);
        return false;
      }
    }

    /**
     * Get complaints by status
     */
    function getComplaintsByStatus(status) {
      const complaints = loadComplaints();
      return Object.values(complaints).filter(c => c.status === status);
    }

    /**
     * Get complaints by department
     */
    function getComplaintsByDepartment(department) {
      const complaints = loadComplaints();
      return Object.values(complaints).filter(c => c.department === department);
    }

    // State and City data
    const statesData = {
      'Andhra Pradesh': ['Visakhapatnam', 'Vijayawada', 'Guntur', 'Nellore', 'Kurnool', 'Tirupati'],
      'Arunachal Pradesh': ['Itanagar', 'Naharlagun', 'Pasighat', 'Tawang'],
      'Assam': ['Guwahati', 'Silchar', 'Dibrugarh', 'Jorhat', 'Nagaon', 'Tinsukia'],
      'Bihar': ['Patna', 'Gaya', 'Bhagalpur', 'Muzaffarpur', 'Darbhanga', 'Purnia'],
      'Chhattisgarh': ['Raipur', 'Bhilai', 'Bilaspur', 'Korba', 'Durg', 'Rajnandgaon'],
      'Goa': ['Panaji', 'Margao', 'Vasco da Gama', 'Mapusa', 'Ponda'],
      'Gujarat': ['Ahmedabad', 'Surat', 'Vadodara', 'Rajkot', 'Bhavnagar', 'Jamnagar'],
      'Haryana': ['Gurugram', 'Faridabad', 'Panipat', 'Ambala', 'Karnal', 'Hisar'],
      'Himachal Pradesh': ['Shimla', 'Dharamshala', 'Solan', 'Mandi', 'Kullu', 'Hamirpur'],
      'Jharkhand': ['Ranchi', 'Jamshedpur', 'Dhanbad', 'Bokaro', 'Deoghar', 'Hazaribagh'],
      'Karnataka': ['Bengaluru', 'Mysuru', 'Mangaluru', 'Hubli', 'Belagavi', 'Davangere'],
      'Kerala': ['Thiruvananthapuram', 'Kochi', 'Kozhikode', 'Thrissur', 'Kollam', 'Kannur'],
      'Madhya Pradesh': ['Bhopal', 'Indore', 'Gwalior', 'Jabalpur', 'Ujjain', 'Sagar'],
      'Maharashtra': ['Mumbai', 'Pune', 'Nagpur', 'Thane', 'Nashik', 'Aurangabad'],
      'Manipur': ['Imphal', 'Thoubal', 'Bishnupur', 'Churachandpur'],
      'Meghalaya': ['Shillong', 'Tura', 'Nongstoin', 'Jowai'],
      'Mizoram': ['Aizawl', 'Lunglei', 'Champhai', 'Serchhip'],
      'Nagaland': ['Kohima', 'Dimapur', 'Mokokchung', 'Tuensang'],
      'Odisha': ['Bhubaneswar', 'Cuttack', 'Rourkela', 'Berhampur', 'Sambalpur', 'Puri'],
      'Punjab': ['Chandigarh', 'Ludhiana', 'Amritsar', 'Jalandhar', 'Patiala', 'Bathinda'],
      'Rajasthan': ['Jaipur', 'Jodhpur', 'Udaipur', 'Kota', 'Ajmer', 'Bikaner'],
      'Sikkim': ['Gangtok', 'Namchi', 'Gyalshing', 'Mangan'],
      'Tamil Nadu': ['Chennai', 'Coimbatore', 'Madurai', 'Tiruchirappalli', 'Salem', 'Tirunelveli'],
      'Telangana': ['Hyderabad', 'Warangal', 'Nizamabad', 'Khammam', 'Karimnagar', 'Mahbubnagar'],
      'Tripura': ['Agartala', 'Udaipur', 'Dharmanagar', 'Kailashahar'],
      'Uttar Pradesh': ['Lucknow', 'Kanpur', 'Ghaziabad', 'Agra', 'Varanasi', 'Meerut', 'Prayagraj'],
      'Uttarakhand': ['Dehradun', 'Haridwar', 'Roorkee', 'Haldwani', 'Rudrapur', 'Nainital'],
      'West Bengal': ['Kolkata', 'Howrah', 'Durgapur', 'Asansol', 'Siliguri', 'Bardhaman'],
      'Delhi': ['New Delhi', 'North Delhi', 'South Delhi', 'East Delhi', 'West Delhi', 'Central Delhi'],
      'Puducherry': ['Puducherry', 'Karaikal', 'Mahe', 'Yanam'],
      'Chandigarh': ['Chandigarh'],
      'Jammu and Kashmir': ['Srinagar', 'Jammu', 'Anantnag', 'Baramulla', 'Udhampur'],
      'Ladakh': ['Leh', 'Kargil']
    };

    const complaintInput = document.getElementById('complaint-input');
    const voiceBtn = document.getElementById('btn-voice');
    const voiceIcon = document.getElementById('voice-icon');
    const voiceText = document.getElementById('voice-text');
    const voiceError = document.getElementById('voice-error');

    const locationInput = document.getElementById('location-input');
    const locateBtn = document.getElementById('btn-locate');
    const locLoader = document.getElementById('loc-loader');
    const locText = document.getElementById('loc-text');
    const stateSelect = document.getElementById('state-select');
    const citySelect = document.getElementById('city-select');

    const submitBtn = document.getElementById('btn-submit');
    const aiIndicator = document.getElementById('ai-indicator');

    const formView = document.getElementById('form-view');
    const submittedView = document.getElementById('submitted-view');
    const complaintIdSpan = document.getElementById('complaint-id');
    const aiConfidenceLabel = document.getElementById('ai-confidence-label');
    const againBtn = document.getElementById('btn-again');

    // ---- Populate State Dropdown ----
    function populateStates() {
      const states = Object.keys(statesData).sort();
      states.forEach(state => {
        const option = document.createElement('option');
        option.value = state;
        option.textContent = state;
        stateSelect.appendChild(option);
      });
    }

    // ---- Handle State Selection ----
    stateSelect.addEventListener('change', function () {
      const selectedState = this.value;
      citySelect.innerHTML = '<option value="" disabled selected>Select City/District</option>';
      citySelect.disabled = false;

      if (selectedState && statesData[selectedState]) {
        statesData[selectedState].forEach(city => {
          const option = document.createElement('option');
          option.value = city;
          option.textContent = city;
          citySelect.appendChild(option);
        });
      }
    });

    // ---- Auto-detect Location ----
    async function detectLocation() {
      if (isDetectingLocation) return;

      if (!navigator.geolocation) {
        alert('Geolocation is not supported by your browser');
        return;
      }

      isDetectingLocation = true;
      locLoader.style.display = 'inline-block';
      locText.textContent = 'Detecting...';
      locateBtn.disabled = true;

      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const { latitude, longitude } = position.coords;

          try {
            // Use Nominatim reverse geocoding API
            const response = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&addressdetails=1`,
              {
                headers: {
                  'User-Agent': 'SAMBANDH.AI Complaint Portal'
                }
              }
            );

            const data = await response.json();

            if (data && data.address) {
              const address = data.address;

              // Extract state
              const state = address.state || '';

              // Extract city/district
              const city = address.city || address.town || address.village || address.county || '';

              // Extract detailed address
              const road = address.road || '';
              const suburb = address.suburb || '';
              const detailedAddress = [road, suburb].filter(Boolean).join(', ');

              // Populate fields
              if (state) {
                // Find matching state in dropdown
                const stateOption = Array.from(stateSelect.options).find(
                  opt => opt.value.toLowerCase().includes(state.toLowerCase()) ||
                    state.toLowerCase().includes(opt.value.toLowerCase())
                );

                if (stateOption) {
                  stateSelect.value = stateOption.value;
                  stateSelect.dispatchEvent(new Event('change'));

                  // Wait a bit for cities to populate, then select city
                  setTimeout(() => {
                    if (city) {
                      const cityOption = Array.from(citySelect.options).find(
                        opt => opt.value.toLowerCase().includes(city.toLowerCase()) ||
                          city.toLowerCase().includes(opt.value.toLowerCase())
                      );
                      if (cityOption) {
                        citySelect.value = cityOption.value;
                      }
                    }
                  }, 100);
                }
              }

              if (detailedAddress) {
                locationInput.value = detailedAddress;
              } else if (data.display_name) {
                locationInput.value = data.display_name.split(',').slice(0, 3).join(', ');
              }

              locText.textContent = 'Location detected!';
              setTimeout(() => {
                locText.textContent = 'Auto-detect';
              }, 2000);
            }
          } catch (error) {
            console.error('Geocoding error:', error);
            alert('Could not fetch address details. Please enter manually.');
          } finally {
            isDetectingLocation = false;
            locLoader.style.display = 'none';
            locateBtn.disabled = false;
          }
        },
        (error) => {
          isDetectingLocation = false;
          locLoader.style.display = 'none';
          locText.textContent = 'Auto-detect';
          locateBtn.disabled = false;

          let errorMessage = 'Location detection failed. ';
          switch (error.code) {
            case error.PERMISSION_DENIED:
              errorMessage += 'Please allow location access.';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage += 'Location information unavailable.';
              break;
            case error.TIMEOUT:
              errorMessage += 'Request timed out. Please try again.';
              break;
            default:
              errorMessage += 'An unknown error occurred.';
          }
          alert(errorMessage);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }

    locateBtn.addEventListener('click', detectLocation);

    // ---- Language buttons ----
    const languageList = document.getElementById('language-list');
    function renderLanguages() {
      languageList.innerHTML = '';
      languages.forEach((lang) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn-language' + (lang.code === selectedLanguage ? ' active' : '');
        btn.textContent = lang.name;
        btn.onclick = () => {
          selectedLanguage = lang.code;
          renderLanguages();
          if (recognition && isRecording) {
            recognition.stop();
            isRecording = false;
            updateVoiceUI();
          }
          initSpeechRecognition();
        };
        languageList.appendChild(btn);
      });
    }

    // ---- Web Speech API init ----
    function initSpeechRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        recognition = null;
        return;
      }
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = selectedLanguage;

      recognition.onresult = (event) => {
        let finalTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript + ' ';
          }
        }
        if (finalTranscript) {
          complaintInput.value += finalTranscript;
          handleComplaintChange();
        }
      };

      recognition.onerror = (event) => {
        voiceError.style.display = 'block';
        voiceError.textContent = 'Error: ' + event.error + '. Please try again.';
        isRecording = false;
        updateVoiceUI();
      };

      recognition.onend = () => {
        isRecording = false;
        updateVoiceUI();
      };
    }

    // ---- Voice record UI ----
    function updateVoiceUI() {
      if (isRecording) {
        voiceBtn.classList.add('recording');
        voiceIcon.textContent = '‚èπ';
        voiceText.textContent = 'Recording... Click to Stop';
      } else {
        voiceBtn.classList.remove('recording');
        voiceIcon.textContent = 'üé§';
        voiceText.textContent = 'Record Voice Complaint (Works in Chrome/Edge)';
      }
    }

    voiceBtn.addEventListener('click', () => {
      voiceError.style.display = 'none';
      voiceError.textContent = '';
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition || !recognition) {
        voiceError.style.display = 'block';
        voiceError.textContent = 'Speech recognition is not supported in your browser. Please use Chrome or Edge.';
        return;
      }
      if (isRecording) {
        recognition.stop();
      } else {
        try {
          recognition.lang = selectedLanguage;
          recognition.start();
          isRecording = true;
          updateVoiceUI();
        } catch (err) {
          voiceError.style.display = 'block';
          voiceError.textContent = 'Could not start recording. Please check your microphone permissions.';
        }
      }
    });

    // ---- AI indicator when complaint has enough text ----
    function handleComplaintChange() {
      if (complaintInput.value.trim().length > 20) {
        aiIndicator.style.display = 'block';
      } else {
        aiIndicator.style.display = 'none';
      }
    }

    complaintInput.addEventListener('input', handleComplaintChange);

    // ---- Submit ----
    submitBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const deptFilter = document.getElementById('department-filter');

      // Validate required fields (except department - AI will suggest it)
      if (!complaintInput.value.trim() || !stateSelect.value || !citySelect.value || !locationInput.value.trim()) {
        complaintInput.reportValidity();
        stateSelect.reportValidity();
        citySelect.reportValidity();
        locationInput.reportValidity();
        return;
      }

      if (recognition && isRecording) {
        recognition.stop();
        isRecording = false;
        updateVoiceUI();
      }

      // Disable submit button during processing
      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing...';

      try {
        // Show AI processing indicator
        aiIndicator.style.display = 'block';
        const aiIndicatorText = document.querySelector('.ai-indicator-sub');
        aiIndicatorText.textContent = 'AI is analyzing your complaint...';

        // Call Gemini AI for classification
        aiClassification = await classifyComplaint(complaintInput.value);

        // Update AI indicator with results
        if (aiClassification && !aiClassification.error) {
          aiIndicatorText.textContent = `Department: ${aiClassification.department} ‚Ä¢ Priority: ${aiClassification.priority}`;
          aiConfidence = aiClassification.confidence || 95;

          // Auto-fill department if not selected
          if (!deptFilter.value) {
            deptFilter.value = aiClassification.department;
          }
        } else {
          aiIndicatorText.textContent = 'Classification completed with warnings';
          aiConfidence = 50;
        }

        // Validate department is now selected
        if (!deptFilter.value) {
          deptFilter.reportValidity();
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Complaint';
          return;
        }

        // Show success and proceed to submitted view
        setTimeout(() => {
          showSubmittedView();
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Complaint';
        }, 1000);

      } catch (error) {
        console.error('Submission error:', error);
        alert('An error occurred while processing your complaint. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Complaint';
        aiIndicator.style.display = 'none';
      }
    });

    function showSubmittedView() {
      const randomId = 'CMPL-2026-00' + (Math.floor(Math.random() * 9000) + 1000);
      complaintIdSpan.textContent = randomId;
      aiConfidenceLabel.textContent = 'AI Confidence: ' + aiConfidence + '%';

      // Display AI classification results if available
      if (aiClassification && !aiClassification.error) {
        // Priority Badge
        const priorityBadge = document.getElementById('priority-badge');
        const priorityClass = `priority-${aiClassification.priority.toLowerCase()}`;
        const priorityIcon = aiClassification.priority === 'High' ? 'üî¥' :
          aiClassification.priority === 'Medium' ? 'üü°' : 'üü¢';
        priorityBadge.innerHTML = `<span class="priority-badge ${priorityClass}">${priorityIcon} ${aiClassification.priority} Priority</span>`;
        priorityBadge.style.display = 'block';

        // Department Info
        const deptInfo = document.getElementById('department-info');
        deptInfo.innerHTML = `<strong>Department:</strong> ${aiClassification.department}`;
        deptInfo.style.display = 'block';

        // Tags
        if (aiClassification.tags && aiClassification.tags.length > 0) {
          const tagsContainer = document.getElementById('tags-container');
          const tagsList = aiClassification.tags.map(tag =>
            `<span class="tag-item">${tag}</span>`
          ).join('');
          tagsContainer.innerHTML = `<div class="tags-label">Tags:</div><div class="tags-list">${tagsList}</div>`;
          tagsContainer.style.display = 'block';
        }

        // Reasoning
        if (aiClassification.reasoning) {
          const reasoning = document.getElementById('ai-reasoning');
          reasoning.textContent = `AI Analysis: ${aiClassification.reasoning}`;
          reasoning.style.display = 'block';
        }
      }

      formView.style.display = 'none';
      submittedView.style.display = 'flex';
    }

    againBtn.addEventListener('click', () => {
      complaintInput.value = '';
      stateSelect.value = '';
      citySelect.value = '';
      citySelect.disabled = true;
      locationInput.value = '';
      document.getElementById('department-filter').value = '';
      aiIndicator.style.display = 'none';
      aiConfidence = 0;
      formView.style.display = 'block';
      submittedView.style.display = 'none';
    });

    // ---- Init ----
    populateStates();
    renderLanguages();
    initSpeechRecognition();
  </script>
</body>

</html>